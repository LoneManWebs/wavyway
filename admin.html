<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Wavy Way</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%); min-height: 100vh; }
        .nav-item.active { background-color: rgba(255, 255, 255, 0.1); border-left: 4px solid #60a5fa; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-danger { background-color: #ef4444; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 500; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900">Admin Login</h2>
                <p class="text-gray-600 mt-2">Wavy Way Restaurant Admin Panel</p>
            </div>
            
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="username" required class="w-full p-3 border rounded-lg" placeholder="admin">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" required class="w-full p-3 border rounded-lg" placeholder="admin123">
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700">
                    Sign In
                </button>
                
                <div class="text-center text-sm text-gray-500">
                    <p>Default: admin / admin123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <div class="flex">
            <!-- Sidebar -->
            <div class="sidebar w-64 text-white">
                <div class="p-6">
                    <div class="flex items-center space-x-3 mb-8">
                        <span class="text-xl font-bold">Wavy Way Admin</span>
                    </div>
                    
                    <nav class="space-y-2">
                        <a href="#" data-section="dashboard" class="nav-item flex items-center space-x-3 p-3 rounded-lg transition">
                            <i class="fas fa-tachometer-alt w-6"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="#" data-section="menu" class="nav-item flex items-center space-x-3 p-3 rounded-lg transition">
                            <i class="fas fa-utensils w-6"></i>
                            <span>Menu Items</span>
                        </a>
                        <a href="#" data-section="testimonials" class="nav-item flex items-center space-x-3 p-3 rounded-lg transition">
                            <i class="fas fa-star w-6"></i>
                            <span>Testimonials</span>
                        </a>
                        <a href="/" class="nav-item flex items-center space-x-3 p-3 rounded-lg transition">
                            <i class="fas fa-external-link-alt w-6"></i>
                            <span>View Website</span>
                        </a>
                        <button id="logoutBtn" class="w-full text-left nav-item flex items-center space-x-3 p-3 rounded-lg transition text-red-300 hover:text-red-100">
                            <i class="fas fa-sign-out-alt w-6"></i>
                            <span>Logout</span>
                        </button>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 p-6">
                <!-- Menu Items Section -->
                <div id="menuSection" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">Menu Items Management</h1>
                        <button onclick="showAddItemModal()" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i> Add New Item
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">ID</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Name</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Category</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Price</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menuTableBody">
                                <!-- Menu items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Testimonials Section -->
                <div id="testimonialsSection" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">Testimonials Management</h1>
                        <button onclick="showAddTestimonialModal()" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i> Add Testimonial
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">ID</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Customer</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Comment</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Rating</th>
                                    <th class="py-3 px-6 text-left text-sm font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="testimonialsTableBody">
                                <!-- Testimonials will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Menu Item Modal -->
    <div id="itemModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="modalTitle">Add Menu Item</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Item Name</label>
                            <input type="text" id="itemName" required class="w-full p-3 border rounded-lg" placeholder="Enter item name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="itemDescription" rows="3" class="w-full p-3 border rounded-lg" placeholder="Enter item description"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Price ($)</label>
                                <input type="number" id="itemPrice" required step="0.01" min="0" class="w-full p-3 border rounded-lg" placeholder="0.00">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select id="itemCategory" required class="w-full p-3 border rounded-lg">
                                    <option value="">Select Category</option>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="dinner">Dinner</option>
                                    <option value="drinks">Drinks</option>
                                    <option value="desserts">Desserts</option>
                                    <option value="snacks">Snacks</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-8">
                        <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary px-6 py-2">
                            Save Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Testimonial Modal -->
    <div id="testimonialModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Add Testimonial</h2>
                    <button onclick="closeTestimonialModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="testimonialForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name</label>
                            <input type="text" id="customerName" required class="w-full p-3 border rounded-lg" placeholder="Enter customer name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                            <select id="rating" class="w-full p-3 border rounded-lg">
                                <option value="5">5 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="2">2 Stars</option>
                                <option value="1">1 Star</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Comment</label>
                            <textarea id="comment" required rows="4" class="w-full p-3 border rounded-lg" placeholder="Enter customer review"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-8">
                        <button type="button" onclick="closeTestimonialModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary px-6 py-2">
                            Add Testimonial
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    let currentUser = null;
    const API_BASE = 'https://api.auraelixir-lb.xyz';
    
    // Helper function for debugging API calls
    async function debugFetch(url, options = {}) {
        console.log(`üåê API Call: ${url}`, options.method || 'GET');
        
        const response = await fetch(url, options);
        console.log(`üåê Response: ${response.status} ${response.statusText}`);
        
        return response;
    }

    // Login functionality
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const credentials = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value
        };
        
        try {
            const response = await debugFetch(`${API_BASE}/api/admin/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(credentials)
            });
            
            if (!response.ok) {
                throw new Error('Login failed');
            }
            
            const data = await response.json();
            
            if (data.success) {
                currentUser = data.user;
                localStorage.setItem('adminToken', data.token);
                showAdminDashboard();
                loadDashboardData();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        } catch (error) {
            console.error('Login error:', error);
            alert('Login failed. Please check credentials and server connection.');
        }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('adminToken');
        currentUser = null;
        showLoginScreen();
    });

    // Navigation between sections
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Add active class to clicked item
            this.classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            const sectionId = this.dataset.section + 'Section';
            document.getElementById(sectionId).classList.remove('hidden');
        });
    });

    // Show/Hide screens
    function showLoginScreen() {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('adminDashboard').classList.add('hidden');
    }

    function showAdminDashboard() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminDashboard').classList.remove('hidden');
        
        // Set first nav item as active
        document.querySelector('.nav-item').click();
    }

    // Modal functions
    function showAddItemModal() {
        document.getElementById('modalTitle').textContent = 'Add Menu Item';
        document.getElementById('itemId').value = '';
        document.getElementById('itemName').value = '';
        document.getElementById('itemDescription').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemCategory').value = '';
        document.getElementById('itemImage').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
        
        document.getElementById('itemModal').classList.remove('hidden');
    }

    function showEditItemModal(item) {
        document.getElementById('modalTitle').textContent = 'Edit Menu Item';
        document.getElementById('itemId').value = item.id;
        document.getElementById('itemName').value = item.name || '';
        document.getElementById('itemDescription').value = item.description || '';
        document.getElementById('itemPrice').value = item.price || '';
        document.getElementById('itemCategory').value = item.category || '';
        
        if (item.image_url) {
            document.getElementById('previewImage').src = item.image_url;
            document.getElementById('imagePreview').classList.remove('hidden');
        } else {
            document.getElementById('imagePreview').classList.add('hidden');
        }
        
        document.getElementById('itemModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('itemModal').classList.add('hidden');
    }

    function showTestimonialModal() {
        document.getElementById('adminCustomerName').value = '';
        document.getElementById('adminRating').value = '5';
        document.getElementById('adminComment').value = '';
        document.getElementById('testimonialModal').classList.remove('hidden');
    }

    function closeTestimonialModal() {
        document.getElementById('testimonialModal').classList.add('hidden');
    }

    // Image preview
    document.getElementById('itemImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // Load dashboard data
    async function loadDashboardData() {
        try {
            const [menuResponse, testimonialsResponse] = await Promise.all([
                debugFetch(`${API_BASE}/api/menu`),
                debugFetch(`${API_BASE}/api/testimonials`)
            ]);
            
            if (!menuResponse.ok || !testimonialsResponse.ok) {
                throw new Error('Failed to fetch data');
            }
            
            const menuItems = await menuResponse.json();
            const testimonials = await testimonialsResponse.json();
            
            // Update statistics
            document.getElementById('totalItems').textContent = menuItems.length;
            document.getElementById('totalTestimonials').textContent = testimonials.length;
            
            // Count unique categories
            const categories = [...new Set(menuItems.map(item => item.category))];
            document.getElementById('totalCategories').textContent = categories.length;
            
            // Load menu items table
            loadMenuItemsTable(menuItems);
            
            // Load testimonials table
            loadTestimonialsTable(testimonials);
            
            // Load recent activity
            loadRecentActivity(menuItems, testimonials);
            
            // Load recent testimonials
            loadRecentTestimonials(testimonials);
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            alert('Failed to load dashboard data. Please check server connection.');
        }
    }

    // Load menu items table
    function loadMenuItemsTable(menuItems) {
        const tableBody = document.getElementById('menuTableBody');
        tableBody.innerHTML = '';
        
        menuItems.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'table-row border-t';
            row.innerHTML = `
                <td class="py-4 px-6">
                    ${item.image_url 
                        ? `<img src="${API_BASE}${item.image_url}" alt="${item.name}" class="w-16 h-16 object-cover rounded">`
                        : `<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
                             <i class="fas fa-utensils text-gray-400"></i>
                           </div>`
                    }
                </td>
                <td class="py-4 px-6">
                    <div>
                        <div class="font-semibold">${escapeHtml(item.name)}</div>
                        <div class="text-sm text-gray-500">${escapeHtml(item.description || 'No description')}</div>
                    </div>
                </td>
                <td class="py-4 px-6">
                    <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">
                        ${escapeHtml(item.category)}
                    </span>
                </td>
                <td class="py-4 px-6 font-semibold">$${parseFloat(item.price || 0).toFixed(2)}</td>
                <td class="py-4 px-6">
                    <div class="flex space-x-2">
                        <button onclick="editMenuItem(${item.id})" 
                                class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            Edit
                        </button>
                        <button onclick="deleteMenuItem(${item.id})" 
                                class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                            Delete
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Load testimonials table
    function loadTestimonialsTable(testimonials) {
        const tableBody = document.getElementById('testimonialsTableBody');
        tableBody.innerHTML = '';
        
        testimonials.forEach(testimonial => {
            const row = document.createElement('tr');
            row.className = 'table-row border-t';
            row.innerHTML = `
                <td class="py-4 px-6 font-semibold">${escapeHtml(testimonial.customer_name)}</td>
                <td class="py-4 px-6 text-gray-600">${escapeHtml(testimonial.comment)}</td>
                <td class="py-4 px-6">
                    <div class="text-yellow-500">
                        ${'‚òÖ'.repeat(testimonial.rating || 0)}${'‚òÜ'.repeat(5 - (testimonial.rating || 0))}
                    </div>
                </td>
                <td class="py-4 px-6 text-sm text-gray-500">
                    ${new Date(testimonial.created_at || Date.now()).toLocaleDateString()}
                </td>
                <td class="py-4 px-6">
                    <button onclick="deleteTestimonial(${testimonial.id})" 
                            class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                        Delete
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Load recent activity
    function loadRecentActivity(menuItems, testimonials) {
        const activityContainer = document.getElementById('recentActivity');
        activityContainer.innerHTML = '';
        
        // Combine and sort by date (most recent first)
        const activities = [
            ...menuItems.slice(0, 3).map(item => ({
                type: 'menu',
                text: `Menu item: "${item.name}"`,
                date: item.created_at
            })),
            ...testimonials.slice(0, 3).map(testimonial => ({
                type: 'testimonial',
                text: `Review from ${testimonial.customer_name}`,
                date: testimonial.created_at
            }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        
        activities.forEach(activity => {
            const activityElement = document.createElement('div');
            activityElement.className = 'flex items-center p-3 bg-gray-50 rounded-lg';
            activityElement.innerHTML = `
                <div class="mr-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${
                        activity.type === 'menu' ? 'bg-blue-100' : 'bg-green-100'
                    }">
                        <i class="fas ${
                            activity.type === 'menu' ? 'fa-utensils text-blue-600' : 'fa-star text-green-600'
                        }"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="font-medium">${escapeHtml(activity.text)}</div>
                    <div class="text-sm text-gray-500">
                        ${new Date(activity.date).toLocaleString()}
                    </div>
                </div>
            `;
            activityContainer.appendChild(activityElement);
        });
    }

    // Load recent testimonials
    function loadRecentTestimonials(testimonials) {
        const container = document.getElementById('recentTestimonials');
        container.innerHTML = '';
        
        testimonials.slice(0, 3).forEach(testimonial => {
            const element = document.createElement('div');
            element.className = 'p-4 border border-gray-200 rounded-lg';
            element.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-semibold">${escapeHtml(testimonial.customer_name)}</div>
                    <div class="text-yellow-500">
                        ${'‚òÖ'.repeat(testimonial.rating || 0)}${'‚òÜ'.repeat(5 - (testimonial.rating || 0))}
                    </div>
                </div>
                <p class="text-gray-600 text-sm mb-2">"${escapeHtml(testimonial.comment)}"</p>
                <div class="text-xs text-gray-400">
                    ${new Date(testimonial.created_at || Date.now()).toLocaleDateString()}
                </div>
            `;
            container.appendChild(element);
        });
    }

    // Edit menu item - fetch item data first
    async function editMenuItem(id) {
        try {
            const response = await debugFetch(`${API_BASE}/api/menu/${id}`);
            if (!response.ok) {
                throw new Error('Failed to fetch item');
            }
            const item = await response.json();
            showEditItemModal(item);
        } catch (error) {
            console.error('Error fetching item:', error);
            alert('Failed to load item data');
        }
    }

    // Save menu item
    document.getElementById('itemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('name', document.getElementById('itemName').value);
        formData.append('description', document.getElementById('itemDescription').value);
        formData.append('price', document.getElementById('itemPrice').value);
        formData.append('category', document.getElementById('itemCategory').value);
        
        const imageFile = document.getElementById('itemImage').files[0];
        if (imageFile) {
            formData.append('image', imageFile);
        }
        
        const itemId = document.getElementById('itemId').value;
        const url = itemId ? `${API_BASE}/api/menu/${itemId}` : `${API_BASE}/api/menu`;
        const method = itemId ? 'PUT' : 'POST';
        
        try {
            const response = await debugFetch(url, {
                method: method,
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(itemId ? 'Item updated successfully!' : 'Item added successfully!');
                closeModal();
                loadDashboardData();
            } else {
                alert(data.error || 'Error saving item. Please try again.');
            }
        } catch (error) {
            console.error('Error saving item:', error);
            alert('Error saving item. Please try again.');
        }
    });

    // Delete menu item
    async function deleteMenuItem(id) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        try {
            const response = await debugFetch(`${API_BASE}/api/menu/${id}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Item deleted successfully!');
                loadDashboardData();
            } else {
                alert(data.error || 'Error deleting item. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('Error deleting item. Please try again.');
        }
    }

    // Delete testimonial
    async function deleteTestimonial(id) {
        if (!confirm('Are you sure you want to delete this testimonial?')) return;
        
        try {
            const response = await debugFetch(`${API_BASE}/api/testimonials/${id}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Testimonial deleted successfully!');
                loadDashboardData();
            } else {
                alert(data.error || 'Error deleting testimonial. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting testimonial:', error);
            alert('Error deleting testimonial. Please try again.');
        }
    }

    // Add testimonial from admin
    document.getElementById('adminTestimonialForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const testimonial = {
            customer_name: document.getElementById('adminCustomerName').value,
            comment: document.getElementById('adminComment').value,
            rating: parseInt(document.getElementById('adminRating').value)
        };
        
        try {
            const response = await debugFetch(`${API_BASE}/api/testimonials`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testimonial)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Testimonial added successfully!');
                closeTestimonialModal();
                loadDashboardData();
            } else {
                alert(data.error || 'Error adding testimonial. Please try again.');
            }
        } catch (error) {
            console.error('Error adding testimonial:', error);
            alert('Error adding testimonial. Please try again.');
        }
    });

    // Utility function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Test API connection on load
    async function testApiConnection() {
        console.log('üîç Testing connection to:', API_BASE);
        
        try {
            const response = await fetch(`${API_BASE}/api/health`);
            if (response.ok) {
                console.log('‚úÖ API Connection Successful!');
                return true;
            } else {
                console.log('‚ùå API Connection Failed:', response.status);
                return false;
            }
        } catch (error) {
            console.log('‚ùå Cannot connect to API:', error);
            return false;
        }
    }

    // Check if user is already logged in
    window.addEventListener('DOMContentLoaded', async function() {
        console.log('üîÑ Admin Panel Loading...');
        console.log('üåê API Base URL:', API_BASE);
        
        // Test connection first
        const connected = await testApiConnection();
        
        if (!connected) {
            alert(`‚ö†Ô∏è Cannot connect to API server at:\n${API_BASE}\n\nPlease ensure:\n1. Server is running\n2. Domain is correctly configured\n3. No network issues`);
        }
        
        const token = localStorage.getItem('adminToken');
        if (token && connected) {
            // In a real app, verify token with server
            currentUser = { username: 'admin' };
            showAdminDashboard();
            loadDashboardData();
        } else if (!token) {
            showLoginScreen();
        }
    });
</script>
</body>
</html>
